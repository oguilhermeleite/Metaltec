// Metaltec Stock Control System - Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and tracking
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String
  password  String
  role      UserRole   @default(OPERATOR)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  movements Movement[]
  productionOrders ProductionOrder[]

  @@map("users")
}

enum UserRole {
  OPERATOR   // Warehouse operators
  MANAGER    // Anderson - production management
  EXPEDITION // Karen - expedition team
  ADMIN      // System admin
}

// Product model - represents each SKU (code + color combination)
model Product {
  id          String   @id @default(cuid())
  code        String   // e.g., "1122", "1510X"
  name        String   // e.g., "Dobradiça", "Puxador"
  color       Color    // MA/ME/BZ/BR/PT/CR
  material    Material @default(ALUMINUM)
  floor       Int      // 1 or 2

  // Location data - JSON structure for flexibility
  // Format: { "L1": 2, "L2": 0, "L3": 1, "L4": "OK", "L5": 2, "L6": 1 }
  // Values: 0 (empty), 1 (1 box), 2 (2 boxes/full), "OK" (in production)
  locations   Json     @default("{}")

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  movements   Movement[]
  overflow    Overflow[]
  productionOrders ProductionOrder[]

  @@unique([code, color])
  @@index([code])
  @@index([floor])
  @@index([color])
  @@map("products")
}

enum Color {
  MA // Marrom (Brown)
  ME // Metal (Silver)
  BZ // Bronze
  BR // Branco (White)
  PT // Preto (Black)
  CR // Cromado (Chrome)
}

enum Material {
  ALUMINUM
  ZAMAK
  STEEL
  BRASS
}

// Movement model - complete audit trail
model Movement {
  id          String       @id @default(cuid())
  productId   String
  product     Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  type        MovementType
  from        String?      // e.g., "L2", "OVERFLOW", "PRODUCTION"
  to          String       // e.g., "L3", "OVERFLOW"
  quantity    Int          // Number of boxes

  userId      String
  user        User         @relation(fields: [userId], references: [id])

  notes       String?
  timestamp   DateTime     @default(now())

  @@index([productId])
  @@index([timestamp])
  @@index([userId])
  @@map("movements")
}

enum MovementType {
  STORAGE        // Storing in shelf
  OVERFLOW       // Moving to overflow
  TRANSFER       // Moving from overflow to shelf
  PRODUCTION     // Marking as in production
  EXPEDITION     // Sending out
  ADJUSTMENT     // Manual adjustment
}

// Overflow model - items waiting for shelf space
model Overflow {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity    Int      // Number of boxes
  storedDate  DateTime @default(now())

  // Where this item is waiting to go
  waitingForFloor  Int?
  waitingForColumn String? // e.g., "L2"

  notes       String?
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?

  @@index([productId])
  @@index([resolved])
  @@index([storedDate])
  @@map("overflow_items")
}

// Production Order model - track items being manufactured
model ProductionOrder {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantityOrdered Int      // Number of boxes ordered
  quantityReceived Int     @default(0)

  orderedBy       String
  orderedByUser   User     @relation(fields: [orderedBy], references: [id])

  expectedDate    DateTime?
  receivedDate    DateTime?

  status          ProductionStatus @default(IN_PRODUCTION)
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([productId])
  @@index([status])
  @@index([expectedDate])
  @@map("production_orders")
}

enum ProductionStatus {
  IN_PRODUCTION  // Currently being made at Guatupê
  RECEIVED       // Arrived at warehouse
  CANCELLED      // Order cancelled
}
